---
title: "Report decisions taken for exam_InTx_addTau.R"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/BulkAnalysis_plusNetwork/")

```

Load libraries and files. 
```{r lo, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
setwd("~/BulkAnalysis_plusNetwork/")
library(tidyverse)
library(DESeq2)
library(ggplot2)
library(cowplot)
odir = "exam_INTER_conditions/static/"

daysv = c("D0","D2","D4","D7")
fmat <- readRDS("data/prefiltered_counts.rds")
metadata <- readRDS("data/metadata.rds")
genes_df <- read.table("data/genesinfo.csv", sep="\t", header=T)
consensus_tau <- readRDS(paste0(odir,"conseTau4DEGs/", "Ext_conseTau.rds"))

```
## Test diff expr Whole Day Matrices

First check  **dispersions** :

```{r full, echo=TRUE, message=FALSE, warning=FALSE}
par(mfrow=c(2,2))
for (d in daysv){
  all <- DESeqDataSetFromMatrix(countData = fmat[, str_detect(colnames(fmat),d)],
                                colData = metadata %>% filter(time==d),
                                design= ~age)
  all$age <- relevel(all$age, ref="Young")
  da <- estimateSizeFactors(all)
  da <- estimateDispersions(da)
  plotDispEsts(da, main=d)
}
par(mfrow=c(1,1))
```

Then Run analysis: For this report, only testing **D2** for fast checking:

```{r fullbis, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
deresfull <- list()
d = "D2"
dmx <- fmat[, str_detect(colnames(fmat),d)]
dmt <- metadata %>% filter(time==d)
keep.d <- apply(dmx, 1, function(w) ifelse(sum(w >= 5)>=3,T,F))
dmx <- dmx[keep.d, ]
ddsm <- DESeqDataSetFromMatrix(countData=dmx, colData=dmt, design = ~age)
ddsm$age <- relevel(ddsm$age, ref="Young")
res <- DESeq(ddsm, full = ~age)
restab <- as_tibble(results(res))
restab$symbol = genes_df[match(rownames(res), genes_df$Geneid),]$symbol
deresfull[[d]] <- restab %>% filter(! is.na(padj))
```


```{r printpadjfull, fig.width=4, fig.height=3}
print(summary(deresfull[["D2"]]$padj))
ggplot(data=deresfull[["D2"]],aes(padj)) + geom_histogram() + labs(title="full padj")

```
Padj values were very bad, all close to 1.


## Test diff exp on Tau filtered matrix :  

```{r infotau}
CUTOFFTAU <- 0.3
# extract only Tau > CUTOFFTAU and deduplicate with max tau
dedup <- list()
for (d in daysv){
  tf <- consensus_tau[[d]] %>% filter(Tau >= CUTOFFTAU) %>% 
      group_by(symbol) %>% slice_max(Tau)
  dedup[[d]] <- tf
}
```

```{r postfilter, echo=TRUE,  message=FALSE, warning=FALSE}
par(mfrow=c(2,2))
for (d in daysv){
  zo <- left_join(dedup[[d]], genes_df, by="symbol")
  tmpo <- DESeqDataSetFromMatrix(countData = fmat[rownames(fmat) %in% zo$Geneid, 
                                                  str_detect(colnames(fmat),d)],
                                 colData = metadata %>% filter(time==d),
                                 design= ~age)
  tmpo$age <- relevel(tmpo$age, ref="Young")
  da <- estimateSizeFactors(tmpo)
  da <- estimateDispersions(da)
  plotDispEsts(da, main=paste(d, ", only genes obtained from Tau >", CUTOFFTAU))
  rm(tmpo)
}
par(mfrow=c(1,1))
```


Same as done for full gene list, test on **D2** for this filtered matrix:

```{r postfilter_bis, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
d = "D2"
resUniqMx <- list()
zo <- left_join(dedup[[d]], genes_df, by="symbol")
smx <- fmat[rownames(fmat) %in% zo$Geneid, str_detect(colnames(fmat),d)]
smm <- metadata %>% filter(time==d)
#  rownames for this day must be unique, set as symbols then:
if (length(unique(rownames(smx))) == length(rownames(smx))){
  print("ok, rownames are unique (ensemblid), setting rownames as symbols")
  chrw = zo[match(rownames(smx), zo$Geneid),]$symbol
  names(chrw) =  zo[match(rownames(smx), zo$Geneid),]$whichMAX  
  rownames(smx) = unname(chrw)
}else{
  print("stop, rownames must be set unique!")
  stop()
}
keep.s <- apply(smx, 1, function(w) ifelse(sum(w >= 5)>= 3, T, F ))
smx <- smx[keep.s,]
ds.s <- DESeqDataSetFromMatrix(countData=smx, colData=smm, design = ~age)
colData(ds.s)$age <- factor(colData(ds.s)$age,
                            levels=c("Young","Old"))
res <- DESeq(ds.s, full = ~age)
restab <- as_tibble(results(res))
restab$symbol = rownames(results(res))
resUniqMx[[d]] <- restab %>% filter(! is.na(padj))

```


```{r printpadjfil, fig.width=4, fig.height=3 }
print(summary(resUniqMx[["D2"]]$padj))
ggplot(data=resUniqMx[["D2"]],aes(padj)) + geom_histogram() + labs(title="Tau selected, padj")

```

## IN CONCLUSION

Padj (BH method result for p values) are invariably extremely bad when entire day
genes are tested for difference in expression at Young vs Old conditions.

In any case, non binary method GSEA will be tested to find Young vs Old pathway
enrichment differences, which relies on ranked genes by their log2FoldChange, 
and NOT on each respective padj value.


```{r notprinted, eval=F}
# NOTE this was the way consensus was initially done: symbols
# new exam_Intx_addTau.R was corrected to take ensemblids (id)
# needconsensus = T
## version consensus only with symbols : 
# if (needconsensus){ 
#   print("an extended version of consensus, including all Tau values")
#   consensus_tau <- list()
#   daysv = c("D0","D2","D4","D7")
#   for (day in daysv){
#     ty <- read.table(paste0("Tau/TauSpecificity_Young",day, ".txt"), sep="\t", header=T)
#     to <- read.table(paste0("Tau/TauSpecificity_Old",day, ".txt"), sep="\t", header=T)
#     # remember = Tau is calculated on meanTPM (mean over replicates' TPMs)
#     #  therefore, its value is influenced by changes in expression due to age
#     # for example, a hypothetical gene1 : [FAPS, sCs, ECs, M1], their meanTPMs
#     # being :   Old =  [100,100,100,100]  ; Young = [100,2000,100,100]
#     #  the result will say that gene1 is 'sCs' specific, but only in Young.
#     #  As a matter of simplicity, by day and by cell type:
#     #             if gene has max TPM in 1 single celltype in at least one age,
#     # it will be included in consensus list:
#     brut <- rbind(ty,to)
#     brut <- brut  %>% filter(nbMAX == 1 ) %>%
#       group_by(symbol, whichMAX) %>%    # whichMAX is the cell type
#       slice(which.max(Tau)) 
#     
#     consensus_tau[[day]] <- brut %>% select(symbol, Tau, class, whichMAX)
#   }
#   for (i in (names(consensus_tau))){
#     print("")
#     print(i)
#     print(table(consensus_tau[[i]]$whichMAX))
#     print(table(consensus_tau[[i]]$class))
#   }
#   saveRDS(consensus_tau, paste0(odir,"conseTau4DEGs/", "Ext_conseTau.rds"))
# }else{
#   print(paste0("consensuslist already exists in :",
#                odir,"conseTau4DEGs/", "Ext_conseTau.rds"))}
```
 <http://rmarkdown.rstudio.com>.